name: PXF CI Pipeline

on:
  push:
    branches: [ merge-with-upstream ]
  pull_request:
    branches: [ merge-with-upstream ]
    types: [opened, synchronize, reopened, edited]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  JAVA_VERSION: "11"
  JAVA_HOME: "/usr/lib/jvm/java-11-openjdk"
  GO_VERSION: "1.21"
  GPHOME: "/usr/local/cloudberry-db"
  CLOUDBERRY_VERSION: "main"
  PXF_HOME: "/usr/local/pxf"

jobs:
  # Stage 1: Build artifacts (runs in parallel)
  build-cloudberry-deb:
    name: Build Cloudberry DEB Package
    runs-on: ubuntu-latest
    container:
      image: apache/incubator-cloudberry:cbdb-build-ubuntu22.04-latest
      options: --user root
    steps:
    - name: Checkout Cloudberry source
      uses: actions/checkout@v4
      with:
        repository: apache/cloudberry
        ref: ${{ env.CLOUDBERRY_VERSION }}
        path: workspace/cloudberry
        submodules: true

    - name: Checkout PXF source (for build script)
      uses: actions/checkout@v4
      with:
        path: cloudberry-pxf

    - name: Build Cloudberry DEB
      run: |
        export WORKSPACE=$PWD/workspace
        export CLOUDBERRY_VERSION=99.0.0
        export CLOUDBERRY_BUILD=1
        bash cloudberry-pxf/concourse/docker/pxf-cbdb-dev/ubuntu/script/build_cloudberry_deb.sh

    - name: Package Cloudberry source
      run: |
        cd workspace
        tar czf cloudberry-source.tar.gz cloudberry/

    - name: Upload DEB artifact
      uses: actions/upload-artifact@v4
      with:
        name: cloudberry-deb
        path: workspace/cloudberry-deb/*.deb
        retention-days: 7

    - name: Upload Cloudberry source artifact
      uses: actions/upload-artifact@v4
      with:
        name: cloudberry-source
        path: workspace/cloudberry-source.tar.gz
        retention-days: 7

  build-docker-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    steps:
    - name: Checkout PXF source
      uses: actions/checkout@v4
      with:
        path: cloudberry-pxf

    - name: Build singlecluster image
      run: |
        cd cloudberry-pxf/concourse/singlecluster
        docker build -t pxf/singlecluster:3 .
        docker save pxf/singlecluster:3 > /tmp/singlecluster-image.tar

    - name: Upload singlecluster image
      uses: actions/upload-artifact@v4
      with:
        name: singlecluster-image
        path: /tmp/singlecluster-image.tar
        retention-days: 1

  # Stage 2: Parallel test jobs using matrix strategy
  pxf-test:
    name: Test PXF - ${{ matrix.test_group }}
    needs: [build-cloudberry-deb, build-docker-images]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        test_group:
          - cli
          - server
          - sanity
          - smoke
          - hdfs
          - hcatalog
          - hcfs
          - hive
          - hbase
          - profile
          - jdbc
          - proxy
          - features
          - gpdb
    steps:
    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/share/boost
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/hostedtoolcache
        sudo docker system prune -af
        df -h

    - name: Checkout PXF source
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        path: cloudberry-pxf
        submodules: true

    - name: Download Cloudberry DEB
      uses: actions/download-artifact@v4
      with:
        name: cloudberry-deb
        path: /tmp

    - name: Download Cloudberry source
      uses: actions/download-artifact@v4
      with:
        name: cloudberry-source
        path: /tmp

    - name: Download singlecluster image
      uses: actions/download-artifact@v4
      with:
        name: singlecluster-image
        path: /tmp

    - name: Load singlecluster image
      run: |
        docker load < /tmp/singlecluster-image.tar

    - name: Prepare Cloudberry source
      run: |
        tar xzf /tmp/cloudberry-source.tar.gz
        chmod -R u+rwX,go+rX cloudberry

    - name: Start Services
      id: start_services
      run: |
        cd cloudberry-pxf
        docker compose -f concourse/docker/pxf-cbdb-dev/ubuntu/docker-compose.yml down -v || true
        docker compose -f concourse/docker/pxf-cbdb-dev/ubuntu/docker-compose.yml build
        docker compose -f concourse/docker/pxf-cbdb-dev/ubuntu/docker-compose.yml up -d
        docker exec pxf-cbdb-dev sudo chown -R gpadmin:gpadmin /home/gpadmin/workspace/cloudberry
        docker cp /tmp/*.deb pxf-cbdb-dev:/tmp/
        docker exec pxf-cbdb-dev sudo chown gpadmin:gpadmin /tmp/*.deb
        docker exec pxf-cbdb-dev bash -lc "cd /home/gpadmin/workspace/cloudberry-pxf/concourse/docker/pxf-cbdb-dev/ubuntu && ./script/entrypoint.sh"

    - name: Run Test - ${{ matrix.test_group }}
      id: run_test
      continue-on-error: true
      run: |
        TEST_GROUP="${{ matrix.test_group }}"
        if [[ "$TEST_GROUP" == "cli" || "$TEST_GROUP" == "server" ]]; then
          docker exec pxf-cbdb-dev bash -lc "cd /home/gpadmin/workspace/cloudberry-pxf/concourse/docker/pxf-cbdb-dev/ubuntu && ./script/pxf-test.sh $TEST_GROUP"
        else
          docker exec pxf-cbdb-dev bash -lc "cd /home/gpadmin/workspace/cloudberry-pxf/automation && source ../concourse/docker/pxf-cbdb-dev/ubuntu/script/pxf-env.sh && make GROUP=$TEST_GROUP"
        fi

    - name: Collect artifacts
      if: always()
      run: |
        mkdir -p artifacts/logs
        echo "Test group: ${{ matrix.test_group }}" > artifacts/manifest.txt
        echo "Test result: ${{ steps.run_test.outcome }}" >> artifacts/manifest.txt
        cp -r cloudberry-pxf/automation/test_artifacts/* artifacts/ 2>/dev/null || true
        docker exec pxf-cbdb-dev bash -c "cp -r /usr/local/pxf/logs/* /tmp/pxf-logs/ 2>/dev/null || true" || true
        docker cp pxf-cbdb-dev:/tmp/pxf-logs artifacts/logs/ 2>/dev/null || true

    - name: Cleanup containers
      if: always()
      run: |
        cd cloudberry-pxf
        docker compose -f concourse/docker/pxf-cbdb-dev/ubuntu/docker-compose.yml down -v || true

    - name: Upload test artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.test_group }}
        path: artifacts/**
        if-no-files-found: ignore
        retention-days: 7

    - name: Check test result
      if: always()
      run: |
        if [ "${{ steps.run_test.outcome }}" == "failure" ]; then
          echo "Test group ${{ matrix.test_group }} failed"
          exit 1
        fi

  # Stage 3: Summary job
  test-summary:
    name: Test Summary
    needs: [pxf-test]
    if: always()
    runs-on: ubuntu-latest
    steps:
    - name: Download all test artifacts
      uses: actions/download-artifact@v4
      with:
        path: all-artifacts
        pattern: test-results-*

    - name: Generate summary
      run: |
        echo "## PXF Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Test Group | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
        
        for dir in all-artifacts/test-results-*; do
          if [ -d "$dir" ]; then
            group=$(basename "$dir" | sed 's/test-results-//')
            if [ -f "$dir/manifest.txt" ]; then
              result=$(grep "Test result:" "$dir/manifest.txt" | cut -d: -f2 | tr -d ' ')
              if [ "$result" == "success" ]; then
                echo "| $group | ✅ success |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| $group | ❌ failure |" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "| $group | ⚠️ unknown |" >> $GITHUB_STEP_SUMMARY
            fi
          fi
        done
