name: PXF CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  CACHE_FOLDER: ~/docker-images-${{ github.sha }}
  CACHE_FILE_UBUNTU_18_04: ~/docker-images-${{ github.sha }}/gpdb_ubuntu-18.04.tgz
  IMAGES_CACHE_KEY: docker-images-${{ github.sha }}
  GPDB_BRANCH: OPENGPDB_STABLE
  GPDB_REPO: https://github.com/open-gpdb/gpdb.git


jobs:
  prepare:
    name: Build images
    runs-on: ubuntu-latest
    steps:
      - name: Docker images caching
        id: cache-images
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.CACHE_FILE_DOCKER_PREFIX }}
            ${{ env.CACHE_FILE_UBUNTU_18_04 }}
          key: ${{ env.IMAGES_CACHE_KEY }}

      - name: Build images
        if: steps.cache-images.outputs.cache-hit != 'true'
        run: |
          docker build -t gpdb_ubuntu-18.04 -f Dockerfile.ubuntu-18.04 .
          mkdir -p ${{ env.CACHE_FOLDER }}
          docker save gpdb_ubuntu-18.04 -o ${{ env.CACHE_FILE_UBUNTU_18_04 }}

  regression:
    name: PXF pg_regress test
    runs-on: ubuntu-latest
    needs: [ prepare ]
    steps:
      # load docker images
      - name: Load docker images
        id: cache-images
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.CACHE_FILE_DOCKER_PREFIX }}
            ${{ env.CACHE_FILE_UBUNTU_18_04 }}
          key: ${{ env.IMAGES_CACHE_KEY }}

      - name: Fail if no cached images
        if: steps.cache-images.outputs.cache-hit != 'true'
        run: |
          echo "Failed to fetch cached docker images. Will now exit..."
          exit 1

      - name: Run test
        run: ${{ matrix.command }}